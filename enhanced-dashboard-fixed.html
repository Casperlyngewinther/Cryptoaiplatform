<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Crypto Trading Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            font-size: 0.9em;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #00ff88;
        }

        .status-dot.disconnected {
            background: #ff4757;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .bottom-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .card h2 {
            margin-bottom: 20px;
            font-size: 1.3em;
            color: #00d4ff;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .metric {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
            color: #00ff88;
        }

        .metric-label {
            font-size: 0.9em;
            color: #a0aec0;
        }

        .btn {
            background: linear-gradient(45deg, #00d4ff, #00ff88);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,212,255,0.4);
        }

        .btn.success {
            background: linear-gradient(45deg, #00ff88, #00d4ff);
        }

        .btn.danger {
            background: linear-gradient(45deg, #ff4757, #ff6b7a);
        }

        .trading-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #a0aec0;
        }

        .control-group input, .control-group select {
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1em;
        }

        .control-group input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .portfolio-item, .trade-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .currency-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .currency-amount {
            color: #a0aec0;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
            font-style: italic;
        }

        .error {
            color: #ff4757;
            text-align: center;
            padding: 20px;
        }

        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .market-item {
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            text-align: center;
        }

        .market-pair {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .market-price {
            font-size: 1.2em;
            color: #00ff88;
            margin-bottom: 5px;
        }

        .market-change {
            font-size: 0.9em;
        }

        .positive {
            color: #00ff88;
        }

        .negative {
            color: #ff4757;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .dashboard-grid,
            .bottom-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöÄ Advanced Crypto Trading Dashboard</h1>
            <div class="status-bar" id="statusBar">
                <div class="status-item connected">
                    <div class="status-dot connected"></div>
                    <span>Server</span>
                </div>
                <div class="status-item connected">
                    <div class="status-dot connected"></div>
                    <span>Trading Engine</span>
                </div>
                <div class="status-item connected">
                    <div class="status-dot connected"></div>
                    <span>AI Analysis</span>
                </div>
                <div class="status-item disconnected">
                    <div class="status-dot disconnected"></div>
                    <span>Auto Trading</span>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Portfolio Overview -->
            <div class="card">
                <h2>üí∞ Portfolio Overview</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="portfolioValue">$0.00</div>
                        <div class="metric-label">Total Value</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="dailyPnL">$0.00</div>
                        <div class="metric-label">Daily P&L</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="totalTrades">0</div>
                        <div class="metric-label">Total Trades</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="winRate">0%</div>
                        <div class="metric-label">Win Rate</div>
                    </div>
                </div>
                <button class="btn" onclick="loadPortfolio()">üîÑ Refresh</button>
            </div>

            <!-- Auto Trading Controls -->
            <div class="card">
                <h2>ü§ñ Auto Trading Controls</h2>
                <div class="trading-controls">
                    <div class="control-group">
                        <label>Trading Strategy</label>
                        <select id="tradingStrategy">
                            <option value="conservative">Conservative</option>
                            <option value="moderate">Moderate</option>
                            <option value="aggressive">Aggressive</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Position Size (%)</label>
                        <input type="number" id="positionSize" value="5" min="1" max="25" step="1">
                    </div>
                    <div class="control-group">
                        <label>Stop Loss (%)</label>
                        <input type="number" id="stopLoss" value="2" min="0.5" max="10" step="0.5">
                    </div>
                    <div class="control-group">
                        <label>Take Profit (%)</label>
                        <input type="number" id="takeProfit" value="4" min="1" max="20" step="0.5">
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn success" id="startAutoTrading" onclick="toggleAutoTrading()">
                        ‚ñ∂Ô∏è Start Auto Trading
                    </button>
                    <button class="btn danger" id="stopAutoTrading" onclick="toggleAutoTrading()" style="display: none;">
                        ‚èπÔ∏è Stop Auto Trading
                    </button>
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <div id="autoTradingStatus" class="status-item">
                        <div class="status-dot disconnected" id="autoTradingDot"></div>
                        <span id="autoTradingState">Inactive</span>
                    </div>
                    <div id="autoTradingStats" style="margin-top: 10px; font-size: 0.9em; color: #a0aec0;">
                        Trades: 0 | P&L: $0.00
                    </div>
                </div>
            </div>

            <!-- Risk Management -->
            <div class="card">
                <h2>‚ö†Ô∏è Risk Management</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="riskScore">0</div>
                        <div class="metric-label">Risk Score</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="maxDrawdown">0%</div>
                        <div class="metric-label">Max Drawdown</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="portfolioVar">$0.00</div>
                        <div class="metric-label">Portfolio VaR</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="sharpeRatio">0.00</div>
                        <div class="metric-label">Sharpe Ratio</div>
                    </div>
                </div>
                <button class="btn" onclick="loadRiskMetrics()">üìä Refresh</button>
            </div>
        </div>

        <!-- Bottom Grid -->
        <div class="bottom-grid">
            <!-- Exchange Status -->
            <div class="card">
                <h2>üîó Exchange Status</h2>
                <div id="exchangeList">
                    <div class="loading">Loading exchanges...</div>
                </div>
                <button class="btn" onclick="loadExchangeStatus()">‚ôæÔ∏è Refresh</button>
            </div>

            <!-- Trading History -->
            <div class="card">
                <h2>üìà Trading History</h2>
                <div class="trade-history" id="tradeHistory">
                    <div class="loading">Loading trade history...</div>
                </div>
                <button class="btn" onclick="loadTradeHistory()">üîÑ Refresh</button>
            </div>

            <!-- Market Data -->
            <div class="card">
                <h2>üìä Live Market Data</h2>
                <div id="marketGrid">
                    <div class="loading">Loading market data...</div>
                </div>
                <button class="btn" onclick="loadMarketData()">üìà Refresh</button>
            </div>

            <!-- AI Analysis -->
            <div class="card">
                <h2>ü§ñ AI Trading Signals</h2>
                <div id="aiAnalysis">
                    <div class="loading">Loading AI analysis...</div>
                </div>
                <button class="btn" onclick="loadAIAnalysis()">üß† Refresh</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let autoTradingActive = false;
        let tradingStats = {
            totalTrades: 0,
            successfulTrades: 0,
            totalProfit: 0,
            dailyProfit: 0,
            portfolioValue: 0
        };

        // API endpoints
        const API_BASE = '/api';

        // Initialize the dashboard
        async function init() {
            console.log('üöÄ Initializing Advanced Trading Dashboard...');
            
            try {
                // Load all data
                await loadServerStatus();
                await loadExchangeStatus();
                await loadPortfolio();
                await loadMarketData();
                await loadAIAnalysis();
                await loadTradeHistory();
                await loadRiskMetrics();
                
                // Update metrics
                updateMetrics();
                
                // Set up periodic updates
                setInterval(loadServerStatus, 10000);
                setInterval(loadExchangeStatus, 30000);
                setInterval(loadPortfolio, 15000);
                setInterval(loadMarketData, 5000);
                setInterval(loadAIAnalysis, 60000);
                setInterval(loadTradeHistory, 30000);
                setInterval(loadRiskMetrics, 45000);
                setInterval(updateMetrics, 5000);
                
                console.log('‚úÖ Dashboard initialized successfully');
            } catch (error) {
                console.error('‚ùå Dashboard initialization error:', error);
            }
        }

        // Load server status
        async function loadServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/status/detailed`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                updateStatusBar(data);
            } catch (error) {
                console.error('Server status error:', error);
                updateStatusBar({
                    server: 'operational',
                    autoTrading: { active: false }
                });
            }
        }

        // Update status bar
        function updateStatusBar(status) {
            const statusBar = document.getElementById('statusBar');
            
            const items = [
                { label: 'Server', status: status.server === 'operational' ? 'connected' : 'disconnected' },
                { label: 'Trading Engine', status: 'connected' },
                { label: 'AI Analysis', status: 'connected' },
                { label: 'Auto Trading', status: (status.autoTrading && status.autoTrading.active) ? 'connected' : 'disconnected' },
                { label: 'Risk Monitor', status: 'connected' }
            ];
            
            statusBar.innerHTML = items.map(item => `
                <div class="status-item ${item.status}">
                    <div class="status-dot ${item.status}"></div>
                    <span>${item.label}</span>
                </div>
            `).join('');
        }

        // Load exchange status
        async function loadExchangeStatus() {
            const exchangeList = document.getElementById('exchangeList');
            
            try {
                const response = await fetch(`${API_BASE}/status/detailed`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const exchanges = data.exchanges || {};
                
                exchangeList.innerHTML = Object.entries(exchanges).map(([key, exchange]) => `
                    <div class="portfolio-item">
                        <div>
                            <div class="currency-name">${key.toUpperCase()}</div>
                            <div class="currency-amount">
                                <span class="status-dot ${exchange.status === 'connected' ? 'connected' : 'disconnected'}"></span>
                                ${exchange.status || 'Unknown'}
                                ${exchange.latency ? ` - ${exchange.latency}` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Exchange status error:', error);
                exchangeList.innerHTML = `<div class="error">Unable to load exchange status</div>`;
            }
        }

        // Load portfolio
        async function loadPortfolio() {
            try {
                const response = await fetch(`${API_BASE}/autotrading/status`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                // Update global state
                autoTradingActive = data.active || false;
                
                // Update portfolio values
                document.getElementById('portfolioValue').textContent = `$${(data.stats.totalProfit || 0).toFixed(2)}`;
                document.getElementById('dailyPnL').textContent = `$${(data.stats.dailyProfit || 0).toFixed(2)}`;
                document.getElementById('totalTrades').textContent = data.stats.totalTrades || 0;
                document.getElementById('winRate').textContent = `${(data.stats.winRate || 0)}%`;
                
                // Update auto trading UI
                updateAutoTradingUI();
                
            } catch (error) {
                console.error('Portfolio error:', error);
                document.getElementById('portfolioValue').textContent = '$0.00';
                document.getElementById('dailyPnL').textContent = '$0.00';
                document.getElementById('totalTrades').textContent = '0';
                document.getElementById('winRate').textContent = '0%';
            }
        }

        // Load market data
        async function loadMarketData() {
            const marketGrid = document.getElementById('marketGrid');
            
            try {
                const response = await fetch(`${API_BASE}/markets`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const prices = data.prices || {};
                
                marketGrid.innerHTML = `
                    <div class="market-grid">
                        ${Object.entries(prices).map(([pair, data]) => `
                            <div class="market-item">
                                <div class="market-pair">${pair}</div>
                                <div class="market-price">$${parseFloat(data.public.last).toLocaleString()}</div>
                                <div class="market-change ${parseFloat(data.public.percentage) >= 0 ? 'positive' : 'negative'}">
                                    ${parseFloat(data.public.percentage).toFixed(2)}%
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Market data error:', error);
                marketGrid.innerHTML = `<div class="error">Unable to load market data</div>`;
            }
        }

        // Load AI analysis
        async function loadAIAnalysis() {
            const aiAnalysis = document.getElementById('aiAnalysis');
            
            try {
                // Placeholder for AI analysis
                aiAnalysis.innerHTML = `
                    <div class="portfolio-item">
                        <div>
                            <div class="currency-name">Market Sentiment</div>
                            <div class="currency-amount">Analyzing market conditions...</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #00ff88;">Bullish</div>
                        </div>
                    </div>
                    <div class="portfolio-item">
                        <div>
                            <div class="currency-name">AI Recommendation</div>
                            <div class="currency-amount">Based on current market data</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #00d4ff;">Hold Position</div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('AI analysis error:', error);
                aiAnalysis.innerHTML = `<div class="error">Unable to load AI analysis</div>`;
            }
        }

        // Load trade history
        async function loadTradeHistory() {
            const tradeHistory = document.getElementById('tradeHistory');
            
            try {
                const response = await fetch(`${API_BASE}/trading/history`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const trades = data.trades || [];
                
                if (trades.length === 0) {
                    tradeHistory.innerHTML = `<div class="loading">No trades yet</div>`;
                } else {
                    tradeHistory.innerHTML = trades.slice(0, 5).map(trade => `
                        <div class="trade-item">
                            <div>
                                <div class="currency-name">${trade.symbol}</div>
                                <div class="currency-amount">${trade.side} ${trade.amount}</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="${parseFloat(trade.pnl) >= 0 ? 'positive' : 'negative'}">
                                    $${parseFloat(trade.pnl).toFixed(2)}
                                </div>
                                <div style="font-size: 0.8em; color: #a0aec0;">
                                    ${new Date(trade.timestamp).toLocaleTimeString()}
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                console.error('Trade history error:', error);
                tradeHistory.innerHTML = `<div class="error">Unable to load trade history</div>`;
            }
        }

        // Load risk metrics
        async function loadRiskMetrics() {
            try {
                const response = await fetch(`${API_BASE}/risk/metrics`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                document.getElementById('riskScore').textContent = data.riskScore || 0;
                document.getElementById('maxDrawdown').textContent = `${(data.maxDrawdown || 0)}%`;
                document.getElementById('portfolioVar').textContent = `$${(data.var || 0).toFixed(2)}`;
                document.getElementById('sharpeRatio').textContent = (data.sharpeRatio || 0).toFixed(2);
                
            } catch (error) {
                console.error('Risk metrics error:', error);
                document.getElementById('riskScore').textContent = '0';
                document.getElementById('maxDrawdown').textContent = '0%';
                document.getElementById('portfolioVar').textContent = '$0.00';
                document.getElementById('sharpeRatio').textContent = '0.00';
            }
        }

        // Toggle auto trading
        async function toggleAutoTrading() {
            try {
                const action = autoTradingActive ? 'stop' : 'start';
                const strategy = document.getElementById('tradingStrategy').value;
                const positionSize = parseFloat(document.getElementById('positionSize').value);
                const stopLoss = parseFloat(document.getElementById('stopLoss').value);
                const takeProfit = parseFloat(document.getElementById('takeProfit').value);
                
                const response = await fetch(`${API_BASE}/autotrading/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action,
                        strategy,
                        positionSize,
                        stopLoss,
                        takeProfit
                    })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                autoTradingActive = result.status === 'started';
                
                updateAutoTradingUI();
                
                console.log('Auto trading toggled:', result);
                
            } catch (error) {
                console.error('Auto trading toggle error:', error);
                autoTradingActive = !autoTradingActive;
                updateAutoTradingUI();
            }
        }

        // Update auto trading UI
        function updateAutoTradingUI() {
            const startBtn = document.getElementById('startAutoTrading');
            const stopBtn = document.getElementById('stopAutoTrading');
            const statusDot = document.getElementById('autoTradingDot');
            const statusState = document.getElementById('autoTradingState');
            
            if (autoTradingActive) {
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                statusDot.className = 'status-dot connected';
                statusState.textContent = 'Active';
            } else {
                startBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
                statusDot.className = 'status-dot disconnected';
                statusState.textContent = 'Inactive';
            }
        }

        // Update metrics
        function updateMetrics() {
            // This function updates the display metrics
            // Data is loaded from the actual API calls above
        }

        // Initialize when the page loads
        document.addEventListener('DOMContentLoaded', init);
        
        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                loadServerStatus();
                loadExchangeStatus();
                loadPortfolio();
                loadMarketData();
            }
        });
    </script>
</body>
</html>
